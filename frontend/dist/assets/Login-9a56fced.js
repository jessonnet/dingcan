import{u as T,a as A,o as G,b as k,E as r,r as V,c as y,d as _,e as u,f as l,w as i,g as b,n as O,t as L,h as f,i as U,j as C}from"./index-c314a4a7.js";import{_ as K}from"./_plugin-vue_export-helper-c27b6911.js";const Q={class:"login-container"},X={class:"login-form"},Y={key:0,class:"login-notice"},Z={key:1,class:"login-tabs"},ee={key:2,class:"login-notice"},oe={key:3,class:"login-content"},se={key:4,class:"login-content wechat-login"},ae={key:5,class:"login-content bind-form"},le={class:"wechat-info"},re=["src"],te={class:"wechat-nickname"},ne={__name:"Login",setup(ce){const I=T(),q=A(),B=f(null),N=f(null),t=f(!1),m=f("password"),R=f(!1),F=f(!1),S=f(!1),v=f(!0),w=f("auto"),M=f(!1),h=U({username:"",password:""}),p=U({username:"",password:""}),g=U({openid:"",nickname:"",avatar:""}),W={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]},E={username:[{required:!0,message:"请输入员工账号",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]};G(async()=>{await z(),await J(),$()});const z=async()=>{try{M.value=!0;const s=await k.get("/api/system/config/wechat");s.success&&(v.value=s.data.enabled,w.value=s.data.mode||"auto",console.log("微信登录配置:",v.value,w.value))}catch(s){console.error("加载微信登录配置失败:",s)}finally{M.value=!1}},J=async()=>{try{const s=await k.get("/api/wechat/check-browser");s.success&&(R.value=s.isWeChat,F.value=s.isHarmonyOS,console.log("浏览器环境:",R.value,F.value),console.log("微信登录配置:",v.value,w.value),v.value&&(w.value==="force"||w.value==="auto"&&R.value)?m.value="wechat":m.value="password")}catch(s){console.error("检测浏览器环境失败:",s)}},P=async()=>{if(console.log("开始登录流程"),!!B.value)try{console.log("开始表单验证"),B.value.validate(async(s,e)=>{if(s){console.log("表单验证成功"),t.value=!0;try{console.log("开始发送登录请求"),console.log("登录表单数据:",h);const o=await k.post("/api/auth/login",h);if(console.log("登录响应数据:",o),o&&o.success){console.log("响应成功，success为true");const a=o.user,n=o.token;console.log("响应user:",a),console.log("响应user.role:",a.role),a.role&&(a.role=a.role.toLowerCase()),localStorage.setItem("token",n),localStorage.setItem("user",JSON.stringify(a)),console.log("存储的token:",localStorage.getItem("token")),console.log("存储的user:",localStorage.getItem("user"));let c="/login";switch(a.role?a.role:""){case"employee":c="/employee/order";break;case"chef":c="/chef/order-status";break;case"admin":c="/admin/system-config";break}console.log("准备跳转到:",c);try{I.push(c),console.log("路由跳转命令已执行")}catch(d){console.error("路由跳转错误:",d),r.error("页面跳转失败，请刷新页面重试")}r.success("登录成功")}else console.error("登录失败，success为false或响应格式错误"),console.error("响应数据:",o),r.error((o==null?void 0:o.message)||"登录失败")}catch(o){console.error("登录错误:",o),console.error("错误消息:",o.message),r.error("登录失败，请检查用户名和密码")}finally{t.value=!1}}else console.error("表单验证失败:",e),r.error("表单验证失败，请检查输入内容")})}catch(s){console.error("登录流程错误:",s),r.error("登录失败，请刷新页面重试"),t.value=!1}},H=async()=>{try{t.value=!0;const s=await k.get("/api/wechat/auth/url");s.success&&s.authUrl?window.location.href=s.authUrl:r.error("获取微信授权链接失败")}catch(s){console.error("微信登录失败:",s),r.error("微信登录失败，请重试")}finally{t.value=!1}},$=async()=>{const s=q.query.code,e=q.query.state;if(s){t.value=!0;try{const o=await k.post("/api/wechat/login",{code:s,state:e});if(o.success)if(o.needBind)S.value=!0,g.openid=o.openid,g.nickname=o.nickname,g.avatar=o.avatar,r.info("首次登录，请绑定员工账号");else{const a=o.user,n=o.token;a.role&&(a.role=a.role.toLowerCase()),localStorage.setItem("token",n),localStorage.setItem("user",JSON.stringify(a));let c="/login";switch(a.role?a.role:""){case"employee":c="/employee/order";break;case"chef":c="/chef/order-status";break;case"admin":c="/admin/system-config";break}I.push(c),r.success("登录成功")}else r.error((o==null?void 0:o.message)||"微信登录失败")}catch(o){console.error("微信登录回调处理失败:",o),r.error("微信登录失败，请重试")}finally{t.value=!1}}},j=async()=>{if(N.value)try{N.value.validate(async s=>{if(s){t.value=!0;try{const e=await k.post("/api/wechat/bind",{openid:g.openid,username:p.username,password:p.password});if(e.success){const o=e.user,a=e.token;o.role&&(o.role=o.role.toLowerCase()),localStorage.setItem("token",a),localStorage.setItem("user",JSON.stringify(o));let n="/login";switch(o.role?o.role:""){case"employee":n="/employee/order";break;case"chef":n="/chef/order-status";break;case"admin":n="/admin/system-config";break}I.push(n),r.success("绑定成功，已登录")}else r.error((e==null?void 0:e.message)||"绑定失败")}catch(e){console.error("绑定失败:",e),r.error("绑定失败，请检查员工账号和密码")}finally{t.value=!1}}else r.error("请填写完整的员工账号和密码")})}catch(s){console.error("绑定流程错误:",s),r.error("绑定失败，请刷新页面重试"),t.value=!1}},D=()=>{S.value=!1,p.username="",p.password="",g.openid="",g.nickname="",g.avatar="",r.info("已取消绑定")};return(s,e)=>{const o=V("el-alert"),a=V("el-input"),n=V("el-form-item"),c=V("el-button"),x=V("el-form");return y(),_("div",Q,[u("div",X,[e[12]||(e[12]=u("h2",null,"单位内部饭堂订餐系统",-1)),v.value?b("",!0):(y(),_("div",Y,[l(o,{title:"系统提示",type:"info",closable:!1,"show-icon":""},{default:i(()=>[...e[6]||(e[6]=[C(" 微信登录功能已禁用，请使用账号密码登录 ",-1)])]),_:1})])),v.value&&w.value==="manual"?(y(),_("div",Z,[u("div",{class:O(["tab-item",{active:m.value==="password"}]),onClick:e[0]||(e[0]=d=>m.value="password")}," 账号密码登录 ",2),u("div",{class:O(["tab-item",{active:m.value==="wechat"}]),onClick:e[1]||(e[1]=d=>m.value="wechat")}," 微信登录 ",2)])):b("",!0),v.value&&w.value==="force"?(y(),_("div",ee,[l(o,{title:"系统提示",type:"success",closable:!1,"show-icon":""},{default:i(()=>[...e[7]||(e[7]=[C(" 当前使用微信登录模式 ",-1)])]),_:1})])):b("",!0),m.value==="password"?(y(),_("div",oe,[l(x,{model:h,rules:W,ref_key:"loginFormRef",ref:B,"label-width":"80px"},{default:i(()=>[l(n,{label:"用户名",prop:"username"},{default:i(()=>[l(a,{modelValue:h.username,"onUpdate:modelValue":e[2]||(e[2]=d=>h.username=d),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1}),l(n,{label:"密码",prop:"password"},{default:i(()=>[l(a,{modelValue:h.password,"onUpdate:modelValue":e[3]||(e[3]=d=>h.password=d),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])]),_:1}),l(n,null,{default:i(()=>[l(c,{type:"primary",onClick:P,class:"login-button",loading:t.value},{default:i(()=>[C(L(t.value?"登录中...":"登录"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])):b("",!0),m.value==="wechat"&&!S.value?(y(),_("div",se,[e[9]||(e[9]=u("div",{class:"wechat-login-info"},[u("p",null,"使用微信快速登录"),u("p",{class:"tip"},"首次登录需要绑定员工账号")],-1)),l(c,{type:"success",onClick:H,class:"wechat-button",loading:t.value},{default:i(()=>[e[8]||(e[8]=u("svg",{class:"wechat-icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},[u("path",{d:"M664.5 335.8c-6.9 0-13.8 0.6-20.6 1.1 2.3-11.8 3.5-24 3.5-36.4 0-101.8-86.7-184.3-193.7-184.3C251.4 116.2 168 192.9 168 288.4c0 53.6 23.6 102.3 62.1 139.1-6.5 19.7-18.7 53.9-21.3 62.1-3.5 11.2 4.1 11.2 8.5 8.1 3.5-2.4 28.1-19.1 39.6-27.1 14.3-10.1 33.2-20.6 46.9-26.5 24.2 8.7 50.8 13.5 78.5 13.5 6.4 0 12.7-0.3 18.9-0.8-2.1-10.3-3.2-21-3.2-31.9 0-97.3 87.3-176.2 195-176.2 107.7 0 195 78.9 195 176.2 0 97.3-87.3 176.2-195 176.2-24.4 0-47.7-4.3-69.2-12.1-12.4 6.7-29.7 16.5-42.8 26.1-10.4 7.6-33.2 23.2-36.4 25.4-4 2.8-11.1 2.8-7.9-7.6 2.4-7.5 13.5-39.3 19.5-57.6 35.2-34.5 56.5-82.3 56.5-135.1 0-7.4-0.5-14.6-1.4-21.8 5.7-0.5 11.5-0.8 17.3-0.8z",fill:"#07C160"}),u("path",{d:"M835.6 485.3c0-80.4-72.3-145.6-161.5-145.6-89.2 0-161.5 65.2-161.5 145.6 0 80.4 72.3 145.6 161.5 145.6 20.6 0 40.4-3.3 58.8-9.3 11.4 5.8 26.6 14.4 39.3 23.5 10.2 7.4 31.4 21.8 34.4 23.8 3.6 2.5 10 2.5 7.1-6.7-2.1-6.6-12.1-34.8-17.5-51.1 29.1-29.8 46.4-70.8 46.4-115.8z",fill:"#07C160"})],-1)),C(" "+L(t.value?"登录中...":"微信一键登录"),1)]),_:1},8,["loading"])])):b("",!0),S.value?(y(),_("div",ae,[u("div",le,[u("img",{src:g.avatar,alt:"微信头像",class:"wechat-avatar"},null,8,re),u("p",te,L(g.nickname),1),e[10]||(e[10]=u("p",{class:"bind-tip"},"请绑定员工账号以完成登录",-1))]),l(x,{model:p,rules:E,ref_key:"bindFormRef",ref:N,"label-width":"80px"},{default:i(()=>[l(n,{label:"员工账号",prop:"username"},{default:i(()=>[l(a,{modelValue:p.username,"onUpdate:modelValue":e[4]||(e[4]=d=>p.username=d),placeholder:"请输入员工账号"},null,8,["modelValue"])]),_:1}),l(n,{label:"密码",prop:"password"},{default:i(()=>[l(a,{modelValue:p.password,"onUpdate:modelValue":e[5]||(e[5]=d=>p.password=d),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])]),_:1}),l(n,null,{default:i(()=>[l(c,{type:"primary",onClick:j,class:"bind-button",loading:t.value},{default:i(()=>[C(L(t.value?"绑定中...":"绑定并登录"),1)]),_:1},8,["loading"])]),_:1}),l(n,null,{default:i(()=>[l(c,{type:"text",onClick:D,class:"cancel-button"},{default:i(()=>[...e[11]||(e[11]=[C(" 取消绑定 ",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])):b("",!0)])])}}},de=K(ne,[["__scopeId","data-v-f660f8c9"]]);export{de as default};
