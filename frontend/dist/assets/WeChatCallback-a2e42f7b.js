import{u as x,a as w,o as T,E as N,r as k,c as i,d as u,e as n,f as t,w as d,t as g,h as p,k as v,j as S,l as W,m as j,p as z}from"./index-c314a4a7.js";import{_ as B}from"./_plugin-vue_export-helper-c27b6911.js";const E={class:"callback-container"},I={class:"callback-content"},O={key:0,class:"loading-state"},P={class:"loading-text"},V={key:1,class:"error-state"},q={class:"error-text"},J={key:2,class:"success-state"},L={__name:"WeChatCallback",setup(M){const m=x(),h=w(),l=p(!0),o=p(""),_=p("正在处理微信授权...");T(async()=>{await y()});const y=async()=>{const f=h.query.code,s=h.query.state;if(!f){o.value="授权失败，未获取到授权码",l.value=!1;return}try{_.value="正在获取用户信息...";const e=await(await fetch("/api/wechat/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:f,state:s})})).json();if(e.success){_.value="正在登录...";const c=e.user,C=e.token;c.role&&(c.role=c.role.toLowerCase()),localStorage.setItem("token",C),localStorage.setItem("user",JSON.stringify(c)),l.value=!1,e.isNewUser&&N.info("欢迎使用！您的账号已自动创建");let r="/login";switch(c.role?c.role:""){case"employee":r="/employee/order";break;case"chef":r="/chef/order-status";break;case"admin":r="/admin/system-config";break}setTimeout(()=>{m.push(r)},1e3)}else e.fallbackToPassword?o.value="微信登录功能已禁用，请使用账号密码登录":o.value=(e==null?void 0:e.message)||"微信登录失败",l.value=!1}catch(a){console.error("微信登录回调处理失败:",a),o.value="网络错误，请稍后重试",l.value=!1}},b=()=>{m.push("/login")};return(f,s)=>{const a=k("el-icon"),e=k("el-button");return i(),u("div",E,[n("div",I,[l.value?(i(),u("div",O,[t(a,{class:"is-loading",size:50},{default:d(()=>[t(v(W))]),_:1}),n("p",P,g(_.value),1)])):o.value?(i(),u("div",V,[t(a,{size:50,color:"#f56c6c"},{default:d(()=>[t(v(j))]),_:1}),n("p",q,g(o.value),1),t(e,{type:"primary",onClick:b},{default:d(()=>[...s[0]||(s[0]=[S("返回登录",-1)])]),_:1})])):(i(),u("div",J,[t(a,{size:50,color:"#67c23a"},{default:d(()=>[t(v(z))]),_:1}),s[1]||(s[1]=n("p",{class:"success-text"},"登录成功",-1)),s[2]||(s[2]=n("p",{class:"redirect-text"},"正在跳转...",-1))]))])])}}},A=B(L,[["__scopeId","data-v-a44eccc6"]]);export{A as default};
