# 饭堂订餐系统 - 双登录模式功能说明

## 功能概述

本系统支持两种登录模式：
1. **账号密码登录**：传统的用户名密码登录方式
2. **微信登录**：基于微信公众号的免账号密码登录

系统会自动检测用户访问环境，在微信内置浏览器中优先显示微信登录选项，在其他浏览器中只显示账号密码登录。

## 功能特性

### 1. 微信端登录流程

- 集成微信网页授权机制，实现用户免账号密码登录
- 严格遵循微信网页授权的标准流程
- 支持获取用户基本信息（昵称、头像等）
- 首次微信登录自动创建账号
- 支持微信账号与现有账号绑定

### 2. 非微信端登录流程

- 保留原有的账号密码登录方式
- 增强安全防护机制
- 登录失败次数限制（5次失败锁定30分钟）
- 密码强度验证
- 实时显示剩余尝试次数

### 3. 系统集成要求

- 自动检测访问环境（微信内置浏览器或其他浏览器）
- 根据检测结果自动切换登录模式
- 两种登录方式统一用户身份标识
- 确保用户数据一致性

### 4. 安全与性能

- 完善的用户身份验证和会话管理
- JWT Token认证机制
- 微信授权过程数据传输安全
- 优化授权流程，减少用户等待时间
- 完善的异常处理机制

### 5. 兼容性

- 支持PC和移动端访问
- 适配各种主流浏览器
- 适配微信内置浏览器
- 响应式设计，移动端友好

## 技术实现

### 后端实现

#### 1. 数据库表结构

**微信用户信息表（wechat_user）**：
```sql
CREATE TABLE `wechat_user` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NULL COMMENT '关联的用户ID（如果已绑定）',
  `openid` VARCHAR(100) UNIQUE NOT NULL COMMENT '微信OpenID',
  `unionid` VARCHAR(100) NULL COMMENT '微信UnionID（如果有）',
  `nickname` VARCHAR(100) NULL COMMENT '微信昵称',
  `avatar` VARCHAR(500) NULL COMMENT '微信头像URL',
  `gender` TINYINT NULL COMMENT '性别（0：未知，1：男，2：女）',
  `country` VARCHAR(50) NULL COMMENT '国家',
  `province` VARCHAR(50) NULL COMMENT '省份',
  `city` VARCHAR(50) NULL COMMENT '城市',
  `language` VARCHAR(20) NULL COMMENT '语言',
  `phone` VARCHAR(20) NULL COMMENT '手机号',
  `subscribe_status` TINYINT NOT NULL DEFAULT 0 COMMENT '关注状态（0：未关注，1：已关注）',
  `subscribe_time` DATETIME NULL COMMENT '关注时间',
  `last_login_time` DATETIME NULL COMMENT '最后登录时间',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='微信用户信息表';
```

#### 2. 核心类

**WeChatConfig**：微信配置类
- 管理微信公众号AppID、AppSecret等配置
- 生成微信授权URL
- 配置授权回调地址

**WeChatAuthService**：微信授权服务
- 获取微信access_token
- 获取微信用户信息
- 处理微信登录逻辑
- 处理账号绑定逻辑

**WeChatController**：微信授权控制器
- 提供微信授权URL接口
- 处理微信授权回调
- 处理微信登录请求
- 处理账号绑定请求
- 检测浏览器环境

**LoginSecurityService**：登录安全服务
- 登录失败次数限制
- 账户锁定机制
- 密码强度验证
- 登录尝试记录

#### 3. API接口

**微信相关接口**：
- `GET /api/wechat/auth/url` - 获取微信授权URL
- `GET /api/wechat/callback` - 微信授权回调
- `POST /api/wechat/login` - 微信登录
- `POST /api/wechat/bind` - 绑定微信账号
- `GET /api/wechat/check-browser` - 检测浏览器环境

**账号密码登录接口**：
- `POST /api/auth/login` - 账号密码登录（已增强安全防护）
- `POST /api/auth/change-password` - 修改密码（已增强密码强度验证）

### 前端实现

#### 1. 登录页面（Login.vue）

**功能特性**：
- 自动检测浏览器环境
- 根据环境显示相应的登录选项
- 支持手动切换登录方式
- 微信登录按钮带图标
- 加载状态提示
- 错误提示

**登录流程**：
1. 页面加载时检测浏览器环境
2. 微信浏览器：默认显示微信登录选项
3. 非微信浏览器：只显示账号密码登录
4. 用户可手动切换登录方式
5. 微信登录跳转到微信授权页面
6. 授权后自动回调处理

#### 2. 微信授权回调页面（WeChatCallback.vue）

**功能特性**：
- 显示授权处理进度
- 加载动画
- 成功/失败状态显示
- 自动跳转到对应页面
- 错误处理和提示

#### 3. 路由配置

新增路由：
- `/wechat/callback` - 微信授权回调页面

## 配置说明

### 后端配置（application.yml）

```yaml
wechat:
  app-id: your_wechat_app_id          # 微信公众号AppID
  app-secret: your_wechat_app_secret  # 微信公众号AppSecret
  redirect-uri: http://your-domain.com/wechat/callback  # 授权回调地址
  scope: snsapi_userinfo              # 授权作用域
  state: STATE                        # 自定义状态值
  token-url: https://api.weixin.qq.com/sns/oauth2/access_token
  user-info-url: https://api.weixin.qq.com/sns/userinfo
  auth-url: https://open.weixin.qq.com/connect/oauth2/authorize
```

### 微信公众号配置

1. **注册微信公众号**
   - 访问：https://mp.weixin.qq.com/
   - 选择"服务号"类型
   - 完成认证流程

2. **获取公众号信息**
   - AppID：公众号的唯一标识
   - AppSecret：公众号的密钥
   - 在"开发" -> "基本配置"中获取

3. **配置授权回调域名**
   - 在"开发" -> "接口权限" -> "网页授权"中设置
   - 回调域名：your-domain.com（不要包含http://或https://）
   - 注意：域名必须经过ICP备案

## 使用说明

### 微信登录流程

1. 用户在微信中打开系统
2. 系统自动检测到微信环境，显示微信登录选项
3. 用户点击"微信一键登录"按钮
4. 跳转到微信授权页面
5. 用户授权后，微信回调到系统
6. 系统获取用户信息并创建/绑定账号
7. 自动登录并跳转到对应页面

### 账号密码登录流程

1. 用户在浏览器中打开系统
2. 系统显示账号密码登录表单
3. 用户输入用户名和密码
4. 系统验证用户信息
5. 验证成功后生成Token
6. 自动登录并跳转到对应页面

### 账号绑定流程

1. 用户先通过微信登录创建账号
2. 登录后可以在个人中心绑定现有账号
3. 输入现有账号的用户名和密码
4. 系统验证后完成绑定
5. 之后可以使用任一方式登录

## 安全机制

### 1. 账号密码登录安全

- 登录失败次数限制：5次失败锁定30分钟
- 密码强度验证：必须包含字母和数字
- 密码长度要求：至少6位
- 实时显示剩余尝试次数
- 账户锁定提示

### 2. 微信登录安全

- 使用微信官方授权流程
- AppSecret安全存储
- 授权回调域名验证
- Token过期时间控制
- 用户数据加密存储

### 3. 会话管理

- JWT Token认证
- Token过期时间：24小时
- 自动Token刷新（可选）
- 安全的Token传输

## 测试指南

### 本地测试

1. **环境准备**
   - 注册微信公众号（测试号即可）
   - 获取AppID和AppSecret
   - 配置授权回调域名

2. **内网穿透**
   - 使用ngrok等工具创建内网穿透
   - 配置微信授权回调域名为ngrok域名

3. **测试步骤**
   - 启动后端服务
   - 启动前端服务
   - 在微信中打开测试链接
   - 测试微信登录流程
   - 测试账号密码登录流程

### 服务器测试

1. **域名配置**
   - 确保域名已解析到服务器
   - 确保域名已ICP备案
   - 配置SSL证书（推荐）

2. **配置更新**
   - 更新application.yml中的微信配置
   - 更新授权回调域名
   - 重启后端服务

3. **测试步骤**
   - 在微信中打开测试链接
   - 测试微信登录流程
   - 测试账号密码登录流程
   - 测试账号绑定流程

## 常见问题

### Q1: 微信登录提示"授权回调域名错误"

**A:** 检查以下几点：
1. 微信后台配置的授权回调域名是否正确
2. 域名格式是否正确（不要包含http://或https://）
3. 域名是否已ICP备案
4. application.yml中的redirect-uri是否正确

### Q2: 获取access_token失败

**A:** 检查以下几点：
1. application.yml中的app-id配置是否正确
2. AppID和AppSecret是否正确
3. 公众号类型是否支持网页授权
4. 公众号是否已认证

### Q3: 微信登录后无法跳转

**A:** 检查以下几点：
1. 前端路由配置是否正确
2. /wechat/callback路由是否正确
3. 浏览器控制台是否有错误信息
4. 后端日志是否有错误信息

### Q4: 账号密码登录失败

**A:** 检查以下几点：
1. 用户名和密码是否正确
2. 账户是否被锁定
3. 密码是否符合强度要求
4. 数据库中用户密码是否正确

### Q5: 如何禁用微信登录功能

**A:** 可以通过以下方式：
1. 不配置微信AppID和AppSecret
2. 在前端隐藏微信登录选项
3. 修改环境检测逻辑

## 部署说明

详细的部署指南请参考：[部署指南.md](./部署指南.md)

## 更新日志

### V1.2.0 (2026-02-06)

**新增功能**：
- 支持微信登录
- 支持双登录模式切换
- 自动检测浏览器环境
- 微信授权回调处理
- 账号绑定功能

**优化功能**：
- 增强账号密码登录安全
- 登录失败次数限制
- 密码强度验证
- 实时显示剩余尝试次数

**新增接口**：
- GET /api/wechat/auth/url
- GET /api/wechat/callback
- POST /api/wechat/login
- POST /api/wechat/bind
- GET /api/wechat/check-browser

**新增页面**：
- 微信授权回调页面

**数据库变更**：
- 新增wechat_user表

## 技术支持

如有问题，请通过以下方式联系：
- GitHub Issues: https://github.com/jessonnet/dingcan/issues
- 部署指南: [部署指南.md](./部署指南.md)

## 许可证

本项目采用 MIT 许可证。
