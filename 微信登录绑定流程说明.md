# 微信登录绑定流程说明

## 概述

本系统采用微信登录与员工账号绑定的方式，确保微信用户与现有员工信息关联，提供安全便捷的登录体验。

## 登录流程

### 1. 首次微信登录（未绑定）

```
用户点击"微信登录"
    ↓
跳转到微信授权页面
    ↓
用户授权后返回code
    ↓
后端获取微信用户信息
    ↓
检查是否已绑定员工账号
    ↓
未绑定 → 返回needBind=true
    ↓
前端显示绑定页面
    ↓
用户输入员工账号和密码
    ↓
后端验证账号密码
    ↓
绑定成功 → 登录成功
```

### 2. 已绑定微信登录

```
用户点击"微信登录"
    ↓
跳转到微信授权页面
    ↓
用户授权后返回code
    ↓
后端获取微信用户信息
    ↓
检查是否已绑定员工账号
    ↓
已绑定 → 直接登录
    ↓
跳转到对应角色页面
```

## 功能特点

### 安全性

1. **账号密码验证**：绑定时需要验证员工账号和密码，确保只有合法员工才能绑定
2. **OpenID唯一性**：每个微信用户的OpenID唯一，防止重复绑定
3. **防止重复绑定**：一个微信账号只能绑定一个员工账号
4. **会话管理**：使用JWT Token进行会话管理，确保登录安全

### 用户体验

1. **首次登录引导**：首次使用微信登录时，系统会引导用户绑定员工账号
2. **微信信息展示**：绑定页面显示微信头像和昵称，提升用户体验
3. **自动登录**：绑定成功后，后续微信登录无需再次输入账号密码
4. **取消绑定**：用户可以取消绑定，重新选择其他登录方式

### 数据管理

1. **微信用户信息**：保存微信用户的OpenID、昵称、头像等信息
2. **员工信息关联**：通过user_id字段关联微信用户和员工信息
3. **登录记录**：记录每次登录时间，便于追踪

## 数据库结构

### wechat_user表

```sql
CREATE TABLE IF NOT EXISTS `wechat_user` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NULL COMMENT '关联的用户ID（如果已绑定）',
  `openid` VARCHAR(100) UNIQUE NOT NULL COMMENT '微信OpenID',
  `unionid` VARCHAR(100) NULL COMMENT '微信UnionID（如果有）',
  `nickname` VARCHAR(100) NULL COMMENT '微信昵称',
  `avatar` VARCHAR(500) NULL COMMENT '微信头像URL',
  `gender` TINYINT NULL COMMENT '性别（0：未知，1：男，2：女）',
  `country` VARCHAR(50) NULL COMMENT '国家',
  `province` VARCHAR(50) NULL COMMENT '省份',
  `city` VARCHAR(50) NULL COMMENT '城市',
  `language` VARCHAR(20) NULL COMMENT '语言',
  `phone` VARCHAR(20) NULL COMMENT '手机号',
  `subscribe_status` TINYINT NOT NULL DEFAULT 0 COMMENT '关注状态（0：未关注，1：已关注）',
  `subscribe_time` DATETIME NULL COMMENT '关注时间',
  `last_login_time` DATETIME NULL COMMENT '最后登录时间',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='微信用户信息表';
```

### 字段说明

| 字段 | 类型 | 说明 | 必需 |
|------|------|------|------|
| id | BIGINT | 主键 | ✅ |
| user_id | BIGINT | 关联的用户ID（如果已绑定） | ❌ |
| openid | VARCHAR(100) | 微信OpenID，唯一 | ✅ |
| unionid | VARCHAR(100) | 微信UnionID（如果有） | ❌ |
| nickname | VARCHAR(100) | 微信昵称 | ❌ |
| avatar | VARCHAR(500) | 微信头像URL | ❌ |
| gender | TINYINT | 性别（0：未知，1：男，2：女） | ❌ |
| country | VARCHAR(50) | 国家 | ❌ |
| province | VARCHAR(50) | 省份 | ❌ |
| city | VARCHAR(50) | 城市 | ❌ |
| language | VARCHAR(20) | 语言 | ❌ |
| phone | VARCHAR(20) | 手机号 | ❌ |
| subscribe_status | TINYINT | 关注状态（0：未关注，1：已关注） | ✅ |
| subscribe_time | DATETIME | 关注时间 | ❌ |
| last_login_time | DATETIME | 最后登录时间 | ❌ |
| created_at | DATETIME | 创建时间 | ✅ |
| updated_at | DATETIME | 更新时间 | ✅ |

## API接口

### 1. 获取微信授权URL

**接口**：`GET /api/wechat/auth/url`

**响应**：
```json
{
  "success": true,
  "authUrl": "https://open.weixin.qq.com/connect/oauth2/authorize?appid=xxx&redirect_uri=xxx&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect"
}
```

### 2. 微信登录

**接口**：`POST /api/wechat/login`

**请求参数**：
```json
{
  "code": "微信授权码",
  "state": "自定义状态值"
}
```

**响应（未绑定）**：
```json
{
  "success": true,
  "needBind": true,
  "openid": "微信OpenID",
  "nickname": "微信昵称",
  "avatar": "微信头像URL"
}
```

**响应（已绑定）**：
```json
{
  "success": true,
  "needBind": false,
  "token": "JWT Token",
  "user": {
    "id": 1,
    "username": "admin",
    "name": "管理员",
    "role": "ADMIN",
    "departmentId": 1,
    "restaurantId": 1,
    "phone": "13800138000",
    "email": "admin@example.com",
    "status": 1
  }
}
```

### 3. 绑定微信账号

**接口**：`POST /api/wechat/bind`

**请求参数**：
```json
{
  "openid": "微信OpenID",
  "username": "员工账号",
  "password": "员工密码"
}
```

**响应**：
```json
{
  "success": true,
  "token": "JWT Token",
  "user": {
    "id": 1,
    "username": "admin",
    "name": "管理员",
    "role": "ADMIN",
    "departmentId": 1,
    "restaurantId": 1,
    "phone": "13800138000",
    "email": "admin@example.com",
    "status": 1
  }
}
```

### 4. 检测浏览器环境

**接口**：`GET /api/wechat/check-browser`

**响应**：
```json
{
  "success": true,
  "isWeChat": true,
  "isHarmonyOS": false,
  "userAgent": "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/8.0.0"
}
```

## 前端页面

### 登录页面（Login.vue）

#### 1. 账号密码登录

- 用户名输入框
- 密码输入框
- 登录按钮

#### 2. 微信登录（未绑定）

- 微信登录按钮
- 提示信息：首次登录需要绑定员工账号

#### 3. 微信绑定页面

- 微信头像显示
- 微信昵称显示
- 员工账号输入框
- 密码输入框
- 绑定并登录按钮
- 取消绑定按钮

## 测试步骤

### 准备工作

1. **微信公众号配置**
   - 申请已认证的服务号
   - 获取AppID和AppSecret
   - 配置授权回调域名

2. **数据库准备**
   - 确保wechat_user表已创建
   - 确保有测试员工账号

3. **后端配置**
   - 配置微信公众号AppID和AppSecret
   - 配置授权回调URL

### 测试流程

#### 测试1：首次微信登录（未绑定）

1. 在微信中打开系统登录页面
2. 点击"微信登录"按钮
3. 授权微信登录
4. 系统显示绑定页面
5. 输入测试员工账号和密码
6. 点击"绑定并登录"
7. 验证是否登录成功

#### 测试2：已绑定微信登录

1. 在微信中打开系统登录页面
2. 点击"微信登录"按钮
3. 授权微信登录
4. 验证是否直接登录成功

#### 测试3：绑定失败（账号密码错误）

1. 在微信中打开系统登录页面
2. 点击"微信登录"按钮
3. 授权微信登录
4. 系统显示绑定页面
5. 输入错误的员工账号或密码
6. 点击"绑定并登录"
7. 验证是否显示错误提示

#### 测试4：取消绑定

1. 在微信中打开系统登录页面
2. 点击"微信登录"按钮
3. 授权微信登录
4. 系统显示绑定页面
5. 点击"取消绑定"
6. 验证是否返回登录页面

#### 测试5：重复绑定

1. 使用已绑定的微信账号再次登录
2. 验证是否直接登录成功
3. 验证是否显示绑定页面

## 常见问题

### 1. 微信授权失败

**原因**：
- 授权回调域名未配置或配置错误
- AppID或AppSecret配置错误
- 微信公众号未认证

**解决方法**：
- 检查授权回调域名配置
- 检查AppID和AppSecret配置
- 确认微信公众号已认证

### 2. 绑定失败

**原因**：
- 员工账号不存在
- 密码错误
- 微信账号已绑定其他员工

**解决方法**：
- 确认员工账号存在
- 确认密码正确
- 检查微信账号是否已绑定

### 3. 登录后跳转错误

**原因**：
- 用户角色配置错误
- 路由配置错误

**解决方法**：
- 检查用户角色配置
- 检查路由配置

### 4. 微信头像显示失败

**原因**：
- 微信头像URL过期
- 网络问题

**解决方法**：
- 重新登录获取最新头像
- 检查网络连接

## 注意事项

1. **安全性**
   - 不要在前端存储敏感信息
   - 使用HTTPS协议
   - 定期更换JWT密钥

2. **用户体验**
   - 提供清晰的错误提示
   - 优化加载速度
   - 支持多种登录方式

3. **数据管理**
   - 定期清理未绑定的微信用户
   - 记录登录日志
   - 备份重要数据

4. **兼容性**
   - 支持微信内置浏览器
   - 支持鸿蒙系统
   - 支持主流浏览器

## 更新日志

### V1.2.2 (2024-02-06)

- 新增微信登录绑定功能
- 优化首次登录流程
- 添加绑定页面UI
- 完善错误处理
- 更新API接口文档

## 技术支持

如有问题，请联系技术支持团队或查看部署指南。
