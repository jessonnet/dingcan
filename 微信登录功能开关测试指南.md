# 微信登录功能开关测试指南

## 测试概述

本文档详细说明了如何测试微信登录功能的开关控制和登录模式切换功能。

## 测试环境准备

### 1. 数据库配置

确保数据库中已添加微信登录相关配置：

```sql
-- 查看当前配置
SELECT * FROM system_config WHERE config_key IN ('wechat_login_enabled', 'wechat_login_mode');
```

### 2. 后端服务启动

```bash
# 启动后端服务
cd d:\xampp\htdocs\order
mvn spring-boot:run
```

### 3. 前端服务启动

```bash
# 启动前端服务
cd d:\xampp\htdocs\order\frontend
npm run dev
```

## 测试场景

### 场景1：微信登录功能启用测试

#### 测试步骤

1. **登录系统**
   - 使用管理员账号登录（admin/admin123）
   - 进入系统管理 → 系统配置

2. **启用微信登录功能**
   - 切换到"登录配置"标签页
   - 确保"微信登录功能"开关处于启用状态
   - 点击"保存"按钮
   - 确认提示"配置更新成功"

3. **验证登录页面**
   - 退出登录
   - 访问登录页面
   - 检查是否显示微信登录选项

#### 预期结果

- 系统配置页面显示微信登录功能已启用
- 登录页面根据登录模式显示相应的登录方式
- 系统日志中记录配置变更操作

#### 验证点

```bash
# 检查数据库配置
SELECT config_key, config_value FROM system_config WHERE config_key = 'wechat_login_enabled';
# 预期结果: config_value = '1'

# 检查操作日志
SELECT * FROM operation_log WHERE module = '系统配置' ORDER BY created_at DESC LIMIT 1;
# 预期结果: 记录了微信登录功能的启用操作
```

### 场景2：微信登录功能禁用测试

#### 测试步骤

1. **登录系统**
   - 使用管理员账号登录
   - 进入系统管理 → 系统配置

2. **禁用微信登录功能**
   - 切换到"登录配置"标签页
   - 将"微信登录功能"开关切换到禁用状态
   - 确认弹窗提示
   - 点击"确定"
   - 点击"保存"按钮
   - 确认提示"配置更新成功"

3. **验证登录页面**
   - 退出登录
   - 访问登录页面
   - 检查是否只显示账号密码登录
   - 检查是否显示提示信息"微信登录功能已禁用，请使用账号密码登录"

#### 预期结果

- 系统配置页面显示微信登录功能已禁用
- 登录页面只显示账号密码登录表单
- 显示系统提示信息
- 微信登录选项完全隐藏

#### 验证点

```bash
# 检查数据库配置
SELECT config_key, config_value FROM system_config WHERE config_key = 'wechat_login_enabled';
# 预期结果: config_value = '0'

# 检查操作日志
SELECT * FROM operation_log WHERE module = '系统配置' ORDER BY created_at DESC LIMIT 1;
# 预期结果: 记录了微信登录功能的禁用操作
```

### 场景3：登录模式 - 自动检测测试

#### 测试步骤

1. **配置登录模式**
   - 使用管理员账号登录
   - 进入系统管理 → 系统配置
   - 切换到"登录配置"标签页
   - 确保"微信登录功能"已启用
   - 将"微信登录模式"设置为"自动检测"
   - 点击"保存"按钮

2. **在微信环境中测试**
   - 使用微信内置浏览器访问登录页面
   - 检查是否自动显示微信登录选项
   - 检查是否默认选中微信登录

3. **在非微信环境中测试**
   - 使用Chrome浏览器访问登录页面
   - 检查是否显示账号密码登录
   - 检查是否隐藏微信登录选项

#### 预期结果

- 微信环境：显示微信登录选项并默认选中
- 非微信环境：只显示账号密码登录
- 登录模式切换流畅无卡顿

#### 验证点

```bash
# 检查数据库配置
SELECT config_key, config_value FROM system_config WHERE config_key = 'wechat_login_mode';
# 预期结果: config_value = 'auto'

# 检查浏览器检测接口
curl http://localhost:8080/api/wechat/check-browser
# 预期结果: 返回浏览器环境信息
```

### 场景4：登录模式 - 强制微信测试

#### 测试步骤

1. **配置登录模式**
   - 使用管理员账号登录
   - 进入系统管理 → 系统配置
   - 切换到"登录配置"标签页
   - 确保"微信登录功能"已启用
   - 将"微信登录模式"设置为"强制微信"
   - 点击"保存"按钮

2. **验证登录页面**
   - 退出登录
   - 访问登录页面
   - 检查是否只显示微信登录
   - 检查是否显示提示信息"当前使用微信登录模式"

3. **测试微信登录流程**
   - 点击"微信一键登录"按钮
   - 完成微信授权
   - 验证登录成功

#### 预期结果

- 登录页面只显示微信登录选项
- 显示系统提示信息
- 账号密码登录完全隐藏
- 微信登录流程正常

#### 验证点

```bash
# 检查数据库配置
SELECT config_key, config_value FROM system_config WHERE config_key = 'wechat_login_mode';
# 预期结果: config_value = 'force'
```

### 场景5：登录模式 - 手动选择测试

#### 测试步骤

1. **配置登录模式**
   - 使用管理员账号登录
   - 进入系统管理 → 系统配置
   - 切换到"登录配置"标签页
   - 确保"微信登录功能"已启用
   - 将"微信登录模式"设置为"手动选择"
   - 点击"保存"按钮

2. **验证登录页面**
   - 退出登录
   - 访问登录页面
   - 检查是否同时显示"账号密码登录"和"微信登录"两个标签
   - 检查是否可以自由切换

3. **测试两种登录方式**
   - 测试账号密码登录
   - 测试微信登录
   - 验证两种方式都能正常工作

#### 预期结果

- 登录页面显示两个登录标签
- 可以自由切换登录方式
- 两种登录方式都能正常工作
- 切换过程流畅无卡顿

#### 验证点

```bash
# 检查数据库配置
SELECT config_key, config_value FROM system_config WHERE config_key = 'wechat_login_mode';
# 预期结果: config_value = 'manual'
```

### 场景6：异常处理和自动降级测试

#### 测试步骤

1. **禁用微信登录功能后尝试微信登录**
   - 确保微信登录功能已禁用
   - 直接访问微信授权回调URL
   - 检查是否显示错误提示
   - 检查是否提示"微信登录功能已禁用，请使用账号密码登录"

2. **网络异常测试**
   - 在微信登录过程中断开网络
   - 检查是否显示网络错误提示
   - 检查是否能自动降级到账号密码登录

3. **配置更新失败测试**
   - 模拟数据库连接失败
   - 尝试更新配置
   - 检查是否显示错误提示
   - 检查配置值是否恢复原值

#### 预期结果

- 异常情况有明确的错误提示
- 系统能够自动降级到账号密码登录
- 配置更新失败时能恢复原值
- 用户体验不受影响

#### 验证点

```bash
# 检查错误日志
tail -f logs/application.log | grep ERROR
# 预期结果: 记录异常信息

# 检查操作日志
SELECT * FROM operation_log WHERE status = 0 ORDER BY created_at DESC LIMIT 5;
# 预期结果: 记录失败的操作
```

## 测试检查清单

### 功能测试

- [ ] 微信登录功能开关可以正常启用/禁用
- [ ] 登录模式可以正常切换（自动检测/强制微信/手动选择）
- [ ] 配置变更能正确保存到数据库
- [ ] 配置变更能正确记录到操作日志
- [ ] 登录页面能根据配置动态显示登录方式
- [ ] 微信登录功能禁用时，微信登录选项完全隐藏
- [ ] 微信登录功能启用时，根据模式显示相应登录方式

### 兼容性测试

- [ ] 微信内置浏览器中登录正常
- [ ] Chrome浏览器中登录正常
- [ ] Firefox浏览器中登录正常
- [ ] Safari浏览器中登录正常
- [ ] 鸿蒙系统浏览器中登录正常

### 异常处理测试

- [ ] 微信登录功能禁用时，尝试微信登录有明确提示
- [ ] 网络异常时有明确的错误提示
- [ ] 配置更新失败时能恢复原值
- [ ] 微信授权失败时有明确的错误提示
- [ ] 用户拒绝授权时有明确的错误提示

### 用户体验测试

- [ ] 配置切换过程流畅无卡顿
- [ ] 登录方式切换过程流畅无卡顿
- [ ] 错误提示信息清晰易懂
- [ ] 操作反馈及时准确
- [ ] 页面加载速度快

## 测试报告模板

### 测试环境

- 测试时间：____年__月__日 __:__
- 测试人员：__________
- 浏览器版本：__________
- 操作系统：__________

### 测试结果

| 测试场景 | 测试结果 | 备注 |
|---------|---------|------|
| 场景1：微信登录功能启用测试 | 通过/失败 | |
| 场景2：微信登录功能禁用测试 | 通过/失败 | |
| 场景3：登录模式 - 自动检测测试 | 通过/失败 | |
| 场景4：登录模式 - 强制微信测试 | 通过/失败 | |
| 场景5：登录模式 - 手动选择测试 | 通过/失败 | |
| 场景6：异常处理和自动降级测试 | 通过/失败 | |

### 问题记录

| 问题编号 | 问题描述 | 严重程度 | 状态 |
|---------|---------|---------|------|
| 1 | | | |
| 2 | | | |

### 测试结论

- [ ] 所有测试场景通过
- [ ] 部分测试场景通过，存在问题
- [ ] 测试未通过，需要修复

### 测试建议

1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

## 常见问题

### Q1: 配置更新后登录页面没有变化？

**A:** 请清除浏览器缓存或使用无痕模式重新访问登录页面。

### Q2: 微信登录功能禁用后，用户还能通过微信登录吗？

**A:** 不能。系统会在微信登录流程中检查配置，如果功能已禁用，会返回错误提示并引导用户使用账号密码登录。

### Q3: 如何查看配置变更的历史记录？

**A:** 可以在系统管理 → 操作日志中查看所有配置变更的历史记录。

### Q4: 登录模式切换会影响已登录的用户吗？

**A:** 不会。登录模式只影响新用户的登录流程，已登录的用户不受影响。

## 联系支持

如果在测试过程中遇到问题，请联系技术支持团队。

---

**文档版本：** V1.0  
**最后更新：** 2024-02-06  
**维护人员：** 张志松